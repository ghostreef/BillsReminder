<% grand_total =  Transaction.all.sum(:amount) %>

<% @sets.each do |set| next if set.categories.empty? %>
  <% total = set.categories.inject(0){|sum,x| sum + x.cached_total } %>

  <fieldset class='set <%= ('complete' if grand_total == total ) %> <%= "js-set_#{set.id}" %>'>
    <legend>
      <%= set.name %> <%= number_to_currency total %>
      <%= link_to('E', graph_category_set_path(set), class: 'taiga') %>
      <%= link_to('h', edit_category_set_path(set), class: 'taiga') %>
      <%= link_to('j', category_set_path(set), method: :delete, data: {confirm: 'Are you sure?'}, class: 'taiga') %>
    </legend>

    <% fake_category = set.missing.present? ? Category.new(name: 'missing', transactions: set.missing) : nil %>
    <%= render 'categories/categories', categories: set.categories, fake_category: fake_category, set: set %>
  </fieldset>
<% end %>